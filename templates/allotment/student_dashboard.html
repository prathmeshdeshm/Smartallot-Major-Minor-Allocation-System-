{% extends 'base.html' %}

{% block content %}
<style>
    .dashboard-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 40px 0;
        margin-bottom: 30px;
        border-radius: 0 0 20px 20px;
    }
    .allocation-card {
        border: none;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        transition: transform 0.3s ease;
        margin-bottom: 30px;
    }
    .allocation-card:hover {
        transform: translateY(-5px);
    }
    .allocation-item {
        display: flex;
        align-items: center;
        padding: 15px;
        margin: 10px 0;
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-radius: 10px;
        border-left: 4px solid #667eea;
    }
    .allocation-item.allocated {
        background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
        border-left-color: #28a745;
    }
    .allocation-item.not-allocated {
        background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
        border-left-color: #dc3545;
    }
    .preference-container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 30px;
    }
    .sortable-list {
        border: 2px dashed #dee2e6;
        border-radius: 15px;
        padding: 20px;
        min-height: 300px;
        background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
        transition: all 0.3s ease;
    }
    .sortable-list:hover {
        border-color: #667eea;
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.1);
    }
    .list-group-item {
        cursor: grab;
        background: white;
        border: 1px solid #e9ecef;
        margin-bottom: 8px;
        padding: 15px;
        border-radius: 10px;
        transition: all 0.3s ease;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }
    .list-group-item:hover {
        transform: translateX(5px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        border-color: #667eea;
    }
    .list-group-item:active {
        cursor: grabbing;
        transform: rotate(2deg);
    }
    .sortable-ghost {
        opacity: 0.4;
        background: linear-gradient(135deg, #c8ebfb 0%, #a8d8ea 100%);
        transform: rotate(5deg);
    }
    .section-title {
        color: #495057;
        font-weight: 600;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 2px solid #e9ecef;
    }
    .btn-modern {
        border-radius: 50px;
        padding: 12px 30px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 1px;
        transition: all 0.3s ease;
        border: none;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    .btn-modern:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 25px rgba(0,0,0,0.2);
    }
    .status-badge {
        padding: 8px 16px;
        border-radius: 20px;
        font-weight: 600;
        font-size: 0.9rem;
    }
    .status-allocated {
        background: #d4edda;
        color: #155724;
    }
    .status-pending {
        background: #fff3cd;
        color: #856404;
    }
    .drag-hint {
        text-align: center;
        color: #6c757d;
        font-style: italic;
        margin-top: 20px;
        padding: 10px;
        background: rgba(102, 126, 234, 0.1);
        border-radius: 10px;
    }
    @media (max-width: 768px) {
        .preference-container {
            grid-template-columns: 1fr;
            gap: 15px;
        }
        .sortable-list {
            min-height: 250px;
        }
        .dashboard-header {
            padding: 30px 0;
        }
    }
</style>

<div class="dashboard-header">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1 class="display-5 fw-bold mb-2">Student Dashboard</h1>
                <p class="lead mb-0">Welcome back, {{ student.name }}!</p>
                <small class="opacity-75">
                    Roll No: {{ student.roll_no }} | Department: {{ student.get_department_display }}
                </small>
            </div>
            <div class="col-md-4 text-md-end">
                <div class="d-flex flex-column align-items-md-end">
                    <span class="badge bg-light text-dark fs-6 mb-2">
                        Percentage: {{ student.percentage }}%
                    </span>
                    <span class="badge bg-success fs-6 mb-2">Active Student</span>
                    <a href="{% url 'logout' %}" class="btn btn-danger btn-sm">
                        <i class="fas fa-sign-out-alt me-1"></i> Logout
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container">

    {# ðŸ”” Preference window status banner #}
    {% if window_status == 'no_window' %}
      <div class="alert alert-warning mb-3">
          <strong>Preference window not configured.</strong>
          You can view your current preferences, but changes will not be saved until the window is opened by the administrator.
      </div>
    {% elif window_status == 'not_started' %}
      <div class="alert alert-info mb-3">
          <strong>Preference window has not started yet.</strong><br>
          You will be able to submit or edit your preferences from
          {{ window.start_at|date:"d M Y, H:i" }} to {{ window.end_at|date:"d M Y, H:i" }}.
      </div>
    {% elif window_status == 'open' %}
      <div class="alert alert-success mb-3">
          <strong>Preference window is open.</strong><br>
          You can freely edit and save your preferences until
          {{ window.end_at|date:"d M Y, H:i" }}.
      </div>
    {% elif window_status == 'ended' %}
      <div class="alert alert-danger mb-3">
          <strong>Preference window has closed.</strong><br>
          You can no longer change your preferences. Existing preferences are kept for allocation.
      </div>
    {% endif %}

    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags|default:'success' }} alert-dismissible fade show" role="alert">
                <i class="fas fa-check-circle me-2"></i>{{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        {% endfor %}
    {% endif %}

    <div class="card allocation-card">
        <div class="card-header bg-primary text-white">
            <h4 class="mb-0"><i class="fas fa-trophy me-2"></i>Your Allocation Results</h4>
        </div>
        <div class="card-body p-4">
            <div class="row">
                <div class="col-md-4">
                    <div class="allocation-item {% if minor1_allocation %}allocated{% else %}not-allocated{% endif %}">
                        <div class="flex-grow-1">
                            <h6 class="mb-1"><i class="fas fa-graduation-cap me-2"></i>Minor 1</h6>
                            <span class="fw-bold">
                                {% if minor1_allocation %}
                                    {{ minor1_allocation.minor_branch.name }}
                                    <span class="status-badge status-allocated ms-2">Allocated</span>
                                {% else %}
                                    Not Yet Allocated
                                    <span class="status-badge status-pending ms-2">Pending</span>
                                {% endif %}
                            </span>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="allocation-item {% if minor2_allocation %}allocated{% else %}not-allocated{% endif %}">
                        <div class="flex-grow-1">
                            <h6 class="mb-1"><i class="fas fa-graduation-cap me-2"></i>Minor 2</h6>
                            <span class="fw-bold">
                                {% if minor2_allocation %}
                                    {{ minor2_allocation.minor_branch.name }}
                                    <span class="status-badge status-allocated ms-2">Allocated</span>
                                {% else %}
                                    Not Yet Allocated
                                    <span class="status-badge status-pending ms-2">Pending</span>
                                {% endif %}
                            </span>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="allocation-item {% if oe_allocation %}allocated{% else %}not-allocated{% endif %}">
                        <div class="flex-grow-1">
                            <h6 class="mb-1"><i class="fas fa-book me-2"></i>Open Elective</h6>
                            <span class="fw-bold">
                                {% if oe_allocation %}
                                    {{ oe_allocation.oe_subject.name }}
                                    <span class="status-badge status-allocated ms-2">Allocated</span>
                                {% else %}
                                    Not Yet Allocated
                                    <span class="status-badge status-pending ms-2">Pending</span>
                                {% endif %}
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <form id="preference-form" method="post">
        {% csrf_token %}
        <input type="hidden" name="minor1_order" id="minor1_order">
        <input type="hidden" name="minor2_order" id="minor2_order">
        <input type="hidden" name="oe_order" id="oe_order">

        <div class="card allocation-card">
            <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-list-ol me-2"></i>Minor 1 Preferences
                </h5>
                {% if not window_is_open %}
                    <span class="badge bg-light text-dark">
                        <i class="fas fa-lock me-1"></i> Read-only
                    </span>
                {% endif %}
            </div>
            <div class="card-body p-4">
                <div class="preference-container">
                    <div>
                        <h6 class="section-title"><i class="fas fa-plus-circle me-2"></i>Available Minors</h6>
                        <div id="available-m1" class="sortable-list">
                            {% for branch in available_m1 %}
                                <div class="list-group-item" data-id="{{ branch.id }}">
                                    <i class="fas fa-graduation-cap me-2 text-primary"></i>{{ branch.name }}
                                </div>
                            {% endfor %}
                        </div>
                        <div class="drag-hint">
                            <i class="fas fa-hand-paper me-2"></i>Drag items to the right to add to your preferences
                        </div>
                    </div>
                    <div>
                        <h6 class="section-title"><i class="fas fa-sort me-2"></i>Your Preferences (Drag to reorder)</h6>
                        <div id="selected-m1" class="sortable-list">
                            {% for pref in selected_m1_prefs %}
                                <div class="list-group-item" data-id="{{ pref.minor_branch.id }}">
                                    <span class="badge bg-primary me-2">{{ pref.priority }}</span>
                                    <i class="fas fa-graduation-cap me-2 text-primary"></i>{{ pref.minor_branch.name }}
                                </div>
                            {% endfor %}
                        </div>
                        <div class="drag-hint">
                            <i class="fas fa-arrows-alt me-2"></i>Drag to reorder your preferences
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card allocation-card">
            <div class="card-header bg-warning text-dark d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-list-ol me-2"></i>Minor 2 Preferences</h5>
                {% if not window_is_open %}
                    <span class="badge bg-light text-dark">
                        <i class="fas fa-lock me-1"></i> Read-only
                    </span>
                {% endif %}
            </div>
            <div class="card-body p-4">
                <div class="preference-container">
                    <div>
                        <h6 class="section-title"><i class="fas fa-plus-circle me-2"></i>Available Minors</h6>
                        <div id="available-m2" class="sortable-list">
                             {% for branch in available_m2 %}
                                <div class="list-group-item" data-id="{{ branch.id }}">
                                    <i class="fas fa-graduation-cap me-2 text-warning"></i>{{ branch.name }}
                                </div>
                            {% endfor %}
                        </div>
                        <div class="drag-hint">
                            <i class="fas fa-hand-paper me-2"></i>Drag items to the right to add to your preferences
                        </div>
                    </div>
                    <div>
                        <h6 class="section-title"><i class="fas fa-sort me-2"></i>Your Preferences (Drag to reorder)</h6>
                        <div id="selected-m2" class="sortable-list">
                            {% for pref in selected_m2_prefs %}
                                <div class="list-group-item" data-id="{{ pref.minor_branch.id }}">
                                    <span class="badge bg-warning text-dark me-2">{{ pref.priority }}</span>
                                    <i class="fas fa-graduation-cap me-2 text-warning"></i>{{ pref.minor_branch.name }}
                                </div>
                            {% endfor %}
                        </div>
                        <div class="drag-hint">
                            <i class="fas fa-arrows-alt me-2"></i>Drag to reorder your preferences
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card allocation-card">
            <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-book me-2"></i>Open Elective Preferences</h5>
                {% if not window_is_open %}
                    <span class="badge bg-light text-dark">
                        <i class="fas fa-lock me-1"></i> Read-only
                    </span>
                {% endif %}
            </div>
            <div class="card-body p-4">
                <div class="preference-container">
                    <div>
                        <h6 class="section-title"><i class="fas fa-plus-circle me-2"></i>Available Open Electives</h6>
                        <div id="available-oe" class="sortable-list">
                             {% for subject in available_oe %}
                                <div class="list-group-item" data-id="{{ subject.id }}">
                                    <i class="fas fa-book me-2 text-success"></i>{{ subject.name }}
                                </div>
                            {% endfor %}
                        </div>
                        <div class="drag-hint">
                            <i class="fas fa-hand-paper me-2"></i>Drag items to the right to add to your preferences
                        </div>
                    </div>
                    <div>
                        <h6 class="section-title"><i class="fas fa-sort me-2"></i>Your Preferences (Drag to reorder)</h6>
                        <div id="selected-oe" class="sortable-list">
                             {% for pref in selected_oe_prefs %}
                                <div class="list-group-item" data-id="{{ pref.oe_subject.id }}">
                                    <span class="badge bg-success me-2">{{ pref.priority }}</span>
                                    <i class="fas fa-book me-2 text-success"></i>{{ pref.oe_subject.name }}
                                </div>
                            {% endfor %}
                        </div>
                        <div class="drag-hint">
                            <i class="fas fa-arrows-alt me-2"></i>Drag to reorder your preferences
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="text-center mt-4">
            {% if window_is_open %}
                <button type="submit" class="btn btn-primary btn-modern btn-lg">
                    <i class="fas fa-save me-2"></i>Save All Preferences
                </button>
            {% else %}
                <button type="button" class="btn btn-secondary btn-modern btn-lg" disabled>
                    <i class="fas fa-lock me-2"></i>Preference Window Closed
                </button>
            {% endif %}
        </div>
    </form>

    {# âœ… PILL IS NOW INSIDE THE BLOCK #}
    {% if window %}
    <div class="text-center my-4">
        {% if window_is_open %}
            <span class="badge px-4 py-2 rounded-pill"
                  style="background:#22c55e; color:white; font-weight:600; box-shadow:0 10px 25px rgba(34,197,94,0.35);">
                <i class="fas fa-unlock me-2"></i>
                PREFERENCE WINDOW OPEN UNTIL
                {{ window.end_at|date:"d M Y, H:i" }}
            </span>
        {% else %}
            <span class="badge px-4 py-2 rounded-pill"
                  style="background:#9ca3af; color:white; font-weight:600; box-shadow:0 10px 25px rgba(148,163,184,0.35);">
                <i class="fas fa-lock me-2"></i>
                PREFERENCE WINDOW CLOSED
            </span>
        {% endif %}
    </div>
    {% endif %}
</div>  {# end .container #}

<script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {

        const windowIsOpen = { window_is_open|yesno:"true,false" }};

        function initSortable(availableId, selectedId, groupName) {
            const availableListEl = document.getElementById(availableId);
            const selectedListEl = document.getElementById(selectedId);
            if (!availableListEl || !selectedListEl) return;

            new Sortable(availableListEl, {
                group: groupName,
                animation: 200,
                ghostClass: 'sortable-ghost',
                chosenClass: 'sortable-chosen',
                dragClass: 'sortable-drag',
                sort: windowIsOpen,
                onAdd: function(evt) {
                    if (!windowIsOpen) return;
                    evt.item.style.transform = 'scale(1.05)';
                    setTimeout(() => { evt.item.style.transform = ''; }, 200);
                    updatePriorityNumbers(selectedId);
                },
                onRemove: function(evt) {
                    if (!windowIsOpen) return;
                    updatePriorityNumbers(selectedId);
                }
            });

            new Sortable(selectedListEl, {
                group: groupName,
                animation: 200,
                ghostClass: 'sortable-ghost',
                chosenClass: 'sortable-chosen',
                dragClass: 'sortable-drag',
                sort: windowIsOpen,
                onUpdate: function(evt) {
                    if (!windowIsOpen) return;
                    updatePriorityNumbers(selectedId);
                }
            });
        }

        function updatePriorityNumbers(selectedId) {
            const items = document.querySelectorAll(`#${selectedId} .list-group-item`);
            items.forEach((item, index) => {
                const badge = item.querySelector('.badge');
                if (badge) {
                    badge.textContent = index + 1;
                }
            });
        }

        initSortable('available-m1', 'selected-m1', 'minor1_group');
        initSortable('available-m2', 'selected-m2', 'minor2_group');
        initSortable('available-oe', 'selected-oe', 'oe_group');

        document.querySelectorAll('.sortable-list').forEach(list => {
            list.addEventListener('mouseenter', function() {
                this.style.borderColor = '#667eea';
                this.style.boxShadow = '0 5px 15px rgba(102, 126, 234, 0.1)';
            });
            list.addEventListener('mouseleave', function() {
                this.style.borderColor = '#dee2e6';
                this.style.boxShadow = 'none';
            });
        });

        const form = document.getElementById('preference-form');
        if (windowIsOpen && form) {
            form.addEventListener('submit', function (e) {
                const submitBtn = this.querySelector('button[type="submit"]');
                const originalText = submitBtn.innerHTML;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Saving...';
                submitBtn.disabled = true;

                function updateHiddenInput(selectedId, hiddenInputId) {
                    const selectedItems = document.querySelectorAll(`#${selectedId} .list-group-item`);
                    const orderedIds = Array.from(selectedItems).map(item => item.dataset.id);
                    document.getElementById(hiddenInputId).value = orderedIds.join(',');
                }

                updateHiddenInput('selected-m1', 'minor1_order');
                updateHiddenInput('selected-m2', 'minor2_order');
                updateHiddenInput('selected-oe', 'oe_order');

                setTimeout(() => {
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                }, 3000);
            });
        }

        if (windowIsOpen) {
            document.querySelectorAll('.list-group-item').forEach(item => {
                item.addEventListener('click', function() {
                    const parent = this.parentElement;
                    const isAvailable = parent.id.startsWith('available');

                    if (isAvailable) {
                        const targetId = parent.id.replace('available', 'selected');
                        const targetList = document.getElementById(targetId);
                        if (targetList) {
                            targetList.appendChild(this);
                            updatePriorityNumbers(targetId);
                        }
                    } else {
                        const targetId = parent.id.replace('selected', 'available');
                        const targetList = document.getElementById(targetId);
                        if (targetList) {
                            targetList.appendChild(this);
                            updatePriorityNumbers(parent.id);
                        }
                    }
                });
            });
        }
    });
</script>
{% endblock %}
